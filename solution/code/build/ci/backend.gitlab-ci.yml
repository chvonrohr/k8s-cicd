

build_backend:
  cache:
    paths:
    - /var/lib/docker/aufs
  script:
  - docker build -t $GITLAB_REPO/$APP:$VERSION -f solution/code/build/package/$APP.Dockerfile solution/code/
  - docker tag $GITLAB_REPO/$APP:$VERSION $GOOGLE_REPO/$APP:$VERSION
  - docker tag $GITLAB_REPO/$APP:$VERSION $GITLAB_REPO/$APP:$TAG
  - docker tag $GITLAB_REPO/$APP:$VERSION $GOOGLE_REPO/$APP:$TAG
  - docker push $GITLAB_REPO/$APP:$VERSION
  - docker push $GITLAB_REPO/$APP:$TAG
  - docker push $GOOGLE_REPO/$APP:$VERSION
  - docker push $GOOGLE_REPO/$APP:$TAG
  tags:
  - docker
  stage: build
  image: docker:stable
  variables:
    APP: backend
  services:
  - docker:dind
  before_script:
  - echo $GCR_KEY > ${HOME}/gcloud-service-key.json
  - docker login -u _json_key --password-stdin https://$GOOGLE_REGISTRY < ${HOME}/gcloud-service-key.json
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker info
  only:
    refs:
      - branches@letsboot/core/kubernetes-course
      - tags
    changes:
    - solution/code/cmd/backend/**/*
    - solution/code/internal/**/*
    - solution/code/pkg/**/*
    - solution/code/config/**/*
    - solution/code/build/**/backend.*
    - solution/code/.gitlab-ci.yml
    - solution/code/*
